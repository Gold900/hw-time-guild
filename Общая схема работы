Общая схема работы
1. Пользователь заходит на сайт – видит таблицу игроков (все видят, редактировать – только свои данные после входа).
2. Нажимает «Войти через Telegram» – его перенаправляет на Telegram для подтверждения.
3. Telegram возвращает его обратно на сайт с специальным токеном в адресной строке.
4. Сайт «ловит» этот токен и обменивает его на данные пользователя (id, имя, username).
5. Сайт запоминает пользователя – теперь он авторизован.
6. При загрузке таблицы проверяется, есть ли у этого пользователя запись в таблице players. Если есть – рядом с его строкой появляется иконка редактирования. Если нет – предлагается создать свою запись.
7. Редактирование – меняет только свою строку, данные уходят в базу.
Что такое сессия и где она хранится?
● Сессия – это информация о том, что пользователь авторизован. В ней лежит id пользователя (UUID), его email (если есть) и метаданные (имя, username из Telegram).
● Supabase сам хранит сессию в браузере, в localStorage. Тебе ничего не нужно придумывать. Просто после редиректа ты вызываешь supabase.auth.getSession() и получаешь текущего пользователя.
● При перезагрузке страницы Supabase автоматически восстановит сессию из localStorage.
Пошаговый план действий
Шаг 1. Настройка Supabase (один раз)
1. Зайди в панель управления Supabase → Authentication → Providers.
2. Включи провайдера Telegram.
3. Создай бота у @BotFather, получи токен.
4. Вставь токен в поле Bot Token в Supabase.
5. В поле Redirect URL укажи адрес твоего сайта, например https://hw-time-guild.neocities.org. Это адрес, куда Telegram вернёт пользователя после входа.
6. Сохрани.
Шаг 2. Подготовка сайта (HTML и JS)
На сайте нужно:
● Добавить кнопку «Войти через Telegram» (показывать, если пользователь не авторизован).
● Добавить блок с именем пользователя и кнопкой «Выйти» (показывать, если авторизован).
● Подключить Supabase SDK (один скрипт).
● Написать код, который:
○ Проверяет при загрузке страницы, есть ли уже сессия.
○ Если есть – показывает имя и кнопку выхода.
○ Если нет – показывает кнопку входа.
○ Обрабатывает нажатие на кнопку входа (вызывает signInWithOAuth).
○ Обрабатывает нажатие на выход.
После редиректа с Telegram Supabase сам «подхватит» токен, и при следующем вызове getSession() ты получишь пользователя.
Шаг 3. Привязка к таблице players
В таблице players у тебя должно быть поле user_id типа uuid (ссылается на auth.users.id). Если его нет – добавь.
Теперь логика при загрузке таблицы:
1. Получаешь список всех игроков из таблицы (как сейчас).
2. Получаешь текущего пользователя (если он есть).
3. Для каждого игрока проверяешь: player.user_id === currentUser?.id.
4. Если совпадает – рядом с этой строкой добавляешь иконку редактирования (✏️).
5. Если у текущего пользователя вообще нет записи (ни у одного игрока не совпал user_id), показываешь кнопку «Заполнить мои данные» (или «Добавить себя»).
Шаг 4. Создание/редактирование записи
● Создание: при нажатии на «Заполнить мои данные» открывается форма (та же, что для добавления игрока), но поля telegram и user_id заполняются автоматически (из данных пользователя). После отправки – INSERT в таблицу с указанием user_id.
● Редактирование: при нажатии на ✏️ открывается форма с текущими данными. После отправки – UPDATE, где в условии id = ... AND user_id = текущий пользователь. Это гарантирует, что никто не сможет изменить чужую запись, даже если попытается отправить запрос вручную.
Шаг 5. Безопасность (RLS)
В Supabase нужно настроить политики доступа, чтобы:
● Любой (даже неавторизованный) мог читать записи (SELECT).
● Только авторизованный пользователь мог создавать запись, при этом user_id должен быть равен его auth.uid().
● Только владелец записи мог её обновлять (UPDATE where user_id = auth.uid()).
● Только администраторы (или вообще никто, кроме владельца) могли удалять (можно пока отключить удаление для обычных пользователей).
Это делается через SQL-политики (Row Level Security). Например:
sql
CREATE POLICY "Users can update own player" ON players
    FOR UPDATE USING (auth.uid() = user_id);
Шаг 6. Обработка ошибок и UX
● Если вход не удался (Telegram вернул ошибку), показывать уведомление.
● Если пользователь уже авторизован, но у него нет записи – подсветить это и предложить создать.
● После успешного входа можно автоматически перезагрузить таблицу, чтобы сразу увидеть иконку редактирования.
Что не нужно делать?
● Не нужно вручную хранить токены или сессии – Supabase всё делает сам.
● Не нужно придумывать сложные механизмы для передачи данных между Telegram и сайтом – OAuth всё берёт на себя.
● Не нужно делать отдельную таблицу для сессий – сессия живёт в браузере, а данные пользователя – в auth.users.
Что дальше?
После того как базовая авторизация заработает, можно добавить:
● Кнопку «Запросить права на редактирование» (если пользователь хочет править чужую запись – отправлять уведомление админу в Telegram, например, через Edge Function).
● Роль администратора (поле is_admin в таблице players), чтобы админ мог редактировать любые записи.
